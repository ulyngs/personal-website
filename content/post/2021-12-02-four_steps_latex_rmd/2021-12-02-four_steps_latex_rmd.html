---
title: "4 steps to using a LaTeX template with R Markdown"
description: |
  You might often want to use a LaTeX template from some journal with R Markdown. Is is relatively simple to do so, but it can be really frustrating to figure out how it works.
author: "Ulrik Lyngs"
date: 2021-12-02
categories:
  - rmarkdown
  - LaTeX 
  - reproducibility
teaser: "/post/2021-12-02-four_steps_latex_rmd/teaser.png"
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<p>I do all my academic writing in <a href="https://bookdown.org/yihui/rmarkdown/" title="R Markdown: The Definitive Guide">R Markdown</a>, so that my work can be more transparent and reproducible for others and my future self.
Along the way, I created a few packages for writing <a href="https://github.com/ulyngs/oxforddown" title="the `oxforddown` template for thesis writing">theses</a> and <a href="https://ulriklyngs.com/post/2018/10/29/r-packages-for-chi-papers-with-r-markdown/">articles</a> that use some specific LaTeX template to format your PDF output for some specific purpose.</p>
<p>As I have gone through this process, I’ve learned that there are 4 specific steps in adapting a LaTeX template for use with R Markdown.
In this post, I go over what they are, and illustrate them with the <a href="https://journals.plos.org/plosone/s/latex">PLOS LaTeX template</a>.</p>
<div id="make-the-template-compile-on-its-own-aka-watch-your" class="section level1">
<h1>Make the template compile on its own (aka, watch your $)</h1>
<p>The first step is to do the simplest thing we could.
That is, just download the LaTeX template files from your journal/conference and tell your R Markdown document to use the <strong>.tex</strong> file for pdf output, without making any changes.</p>
<p>So imagine we download the <a href="https://journals.plos.org/plosone/s/latex">PLOS LaTeX template</a>, which will give us a folder called <strong>plos-latex-template</strong> that includes the file <strong>plos_latex_template.tex</strong>.</p>
<p>Let’s create a new R Markdown file with this content:</p>
<pre class="markdown"><code>---
output: 
  bookdown::pdf_document2:
    template: plos_latex_template.tex
---

# Hello, LaTeX template!

This is a test.</code></pre>
<p>Yay, let’s try knitting to PDF!
Argh, we get this error message:</p>
<pre class="markdown"><code>Error compiling template &quot;plos_latex_template.tex&quot; (line 57, column 121):
unexpected &quot;2&quot;
expecting &quot;$&quot;
Error: pandoc document conversion failed with error 5
Execution halted</code></pre>
<p>What’s going on?
Well it turns out that dollar signs ($) have a special meaning for <a href="https://pandoc.org">pandoc</a>, the program that is responsible for part of the journey from R Markdown file to PDF output.
Basically, when pandoc sees a dollar sign in your template, then it thinks you want it to plug in some variable from your R Markdown file.</p>
<p>How do we solve this?
Well, we just throw more money at the problem: <strong>for pandoc, a dollar sign in your template is escapes with another dollar sign…</strong> So replace all the single $ with $$ in <strong>.plos_latex_template.tex.</strong></p>
<p>If we now knit to PDF, we get the expected output:</p>
<p><img src="/post/2021-12-02-four_steps_latex_rmd/compile_correct.png" width="100%" style="display: block; margin: auto;" /></p>
</div>
<div id="pull-in-desired-content-from-the-r-markdown-file" class="section level1">
<h1>Pull in desired content from the R Markdown file</h1>
<p>Great!
Our R Markdown file compiled using the <strong>.tex</strong> file as a template!
The only content we see is the sample content from the <strong>.tex</strong> file.
How do we insert content from our R Markdown file?
<strong>Use dollar signs:</strong></p>
<p>Whenever pandoc sees something in the <strong>.tex</strong> file surrounded by single dollar signs, it’ll look for something that corresponds in the R Markdown file.
We need to ask ourselves this: what and where do we want to plug in stuff from the YAML header (i.e., the stuff in between <code>---</code> at the top), and where do we want to plug in our body content?</p>
<div id="pulling-in-stuff-from-the-yaml-header" class="section level2">
<h2>Pulling in stuff from the YAML header</h2>
<p>So we could start by simply adding a title to our R Markdown file, like so:</p>
<pre class="markdown"><code>---
title: &quot;R Markdown + LaTeX Templates = &lt;3&quot;
output: 
  bookdown::pdf_document2:
    template: plos_latex_template.tex
---

# Hello, LaTeX template!

This is a test.</code></pre>
<p>Then we open up <strong>plos_latex_template.tex</strong> and looks for where we find the title.
It’s here:</p>
<pre class="latex"><code>% Title must be 250 characters or less.
\begin{flushleft}
{\Large
\textbf\newline{Title of submission to PLOS journals} % Please use &quot;sentence case&quot; for title and headings (capitalize only the first word in a title (or heading), the first word in a subtitle (or subheading), and any proper nouns).
}
\newline</code></pre>
<p>Let’s change it to this:</p>
<pre class="latex"><code>% Title must be 250 characters or less.
\begin{flushleft}
{\Large
\textbf\newline{$title$} % Please use &quot;sentence case&quot; for title and headings (capitalize only the first word in a title (or heading), the first word in a subtitle (or subheading), and any proper nouns).
}
\newline</code></pre>
<p>Now, if we knit we get this:</p>
<p><img src="/post/2021-12-02-four_steps_latex_rmd/pull-title.png" width="100%" style="display: block; margin: auto;" /></p>
<p>The variable names in your yaml header can be completely arbitrary, by the way.
They don’t have to match something that pandoc has seen before.
So let’s pull in also something for the abstract and the author summary, but use silly names:</p>
<pre class="markdown"><code>---
title: &quot;R Markdown + LaTeX Templates = &lt;3&quot;
silly-abstract: &quot;This is the greatest and best abstract in the world.&quot;
silly-author-summary: &quot;The important thing to know about this paper is that it is was written in close collaboration with Tenacious D, without whom our academic universe would have seized to be.&quot;
output: 
  bookdown::pdf_document2:
    template: plos_latex_template.tex
---

# Hello, LaTeX template!

This is a test.</code></pre>
<p>Then we find the abstract and author summary sections in <strong>plos_latex_template.tex</strong> and replace the sample content with our silly variables:</p>
<pre class="latex"><code>% Please keep the abstract below 300 words
\section*{Abstract}
$silly-abstract$

% Please keep the Author Summary between 150 and 200 words
% Use first person. PLOS ONE authors please skip this step. 
% Author Summary not valid for PLOS ONE submissions.   
\section*{Author summary}
$silly-author-summary$</code></pre>
<p>And when we knit we get the expected output:</p>
<p><img src="/post/2021-12-02-four_steps_latex_rmd/pull-yaml-silly.png" width="100%" style="display: block; margin: auto;" /></p>
</div>
<div id="pulling-in-the-body-content" class="section level2">
<h2>Pulling in the body content</h2>
<p>The body content is pulled in with a special variable: Wherever we write <code>$body$</code> in the <strong>.tex</strong> template, pandoc will insert our the body content.</p>
<p>So in the case of the PLOS template, we replace everything from the introduction to the acknowledgments sections with simply <code>$body$</code>:</p>
<pre class="latex"><code>% Use &quot;Eq&quot; instead of &quot;Equation&quot; for equation citations.
\section*{Introduction}
Lorem ipsum dolor sit~\cite{bib1} amet, consectetur adipiscing elit. Curabitur eget porta erat. Morbi consectetur est vel gravida pretium. Suspendisse ut dui eu ante cursus gravida non sed...</code></pre>
<p>becomes just</p>
<pre class="latex"><code>$body$</code></pre>
<p>And when we knit we get:</p>
<p><img src="/post/2021-12-02-four_steps_latex_rmd/pull-body.png" width="100%" style="display: block; margin: auto;" /></p>
<p>(Note that there are some references at the bottom here, even though nothing’s cited in the text. In the PLOS template, the references section is manually inserted in the <strong>.tex</strong> template, and I left this section in at the bottom of the file. We’ll get to this in a minute!)</p>
</div>
</div>
<div id="enable-code-inclusion" class="section level1">
<h1>Enable code inclusion</h1>
<p>Next, you’ll notice that if we add a code chunk in our R Markdown file, with the chunk option <code>echo=TRUE</code>, we’ll get an error:</p>
<pre class="markdown"><code>---
title: &quot;R Markdown + LaTeX Templates = &lt;3&quot;
output: 
  bookdown::pdf_document2:
    template: plos_latex_template.tex
---

# Hello, LaTeX template!

This is a test.


```r
2 + 2
```

```
## [1] 4
```</code></pre>
<p>Specifically, we get this:</p>
<pre class="markdown"><code>! LaTeX Error: Environment Shaded undefined.

Error: LaTeX failed to compile using-latex-templates.tex. See https://yihui.org/tinytex/r/#debugging for debugging tips. See using-latex-templates.log for more info.
Execution halted</code></pre>
<p>As the error message suggests, this is because code chunks are included in the <strong>.tex</strong> output in a ‘Shaded’ environment, like so in our example:</p>
<pre class="latex"><code>\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{2} \SpecialCharTok{+} \DecValTok{2}
\end{Highlighting}
\end{Shaded}</code></pre>
<p>But our template <strong>.tex</strong> file doesn’t currently define this environment.</p>
<p>We fix it by adding the following lines to the LaTeX template, somewhere before the <code>\begin{document}</code> command:</p>
<pre class="latex"><code>$if(highlighting-macros)$
$highlighting-macros$
$endif$</code></pre>
<p>What this will do is that <em>if</em> our R Markdown document includes code chunks that have <code>echo=TRUE</code> so that the code will be displayed, <em>then</em> the necessary LaTeX packages and environments will be added to the template automatically.
If we knit again, then we see the expected output:</p>
<p><img src="/post/2021-12-02-four_steps_latex_rmd/enable-code.png" width="100%" style="display: block; margin: auto;" /></p>
</div>
<div id="decide-how-to-include-citations" class="section level1">
<h1>Decide how to include citations</h1>
<p>Finally, we need to think about how we want to include citations.
We have at least three options available:</p>
<ol style="list-style-type: decimal">
<li>Use CSL (<a href="https://citationstyles.org">Citation Style Language</a>) references</li>
<li>Use the <code>natbib</code> LaTeX package</li>
<li>Use the <code>biblatex</code> LaTeX package</li>
</ol>
<p>Let’s look at each of these options.</p>
<div id="csl-references" class="section level2">
<h2>CSL references</h2>
<p>The <a href="https://citationstyles.org">Citation Style Language</a> is an open-source project supported by Zotero, Mendeley, RefWorks, and others, and is the approach <code>pandoc</code> uses by default.
To enable it, we need to include the following in our LaTeX template:</p>
<pre class="latex"><code>$if(csl-refs)$
\newlength{\cslhangindent}
\setlength{\cslhangindent}{1.5em}
\newlength{\csllabelwidth}
\setlength{\csllabelwidth}{3em}
\newlength{\cslentryspacingunit} % times entry-spacing
\setlength{\cslentryspacingunit}{\parskip}
\newenvironment{CSLReferences}[2] % #1 hanging-ident, #2 entry spacing
 {% don&#39;t indent paragraphs
  \setlength{\parindent}{0pt}
  % turn on hanging indent if param 1 is 1
  \ifodd #1
  \let\oldpar\par
  \def\par{\hangindent=\cslhangindent\oldpar}
  \fi
  % set entry spacing
  \setlength{\parskip}{#2\cslentryspacingunit}
 }%
 {}
\usepackage{calc}
\newcommand{\CSLBlock}[1]{#1\hfill\break}
\newcommand{\CSLLeftMargin}[1]{\parbox[t]{\csllabelwidth}{#1}}
\newcommand{\CSLRightInline}[1]{\parbox[t]{\linewidth - \csllabelwidth}{#1}\break}
\newcommand{\CSLIndent}[1]{\hspace{\cslhangindent}#1}
$endif$</code></pre>
<p>(These commands come from the default <span class="math display">\[`pandoc` LaTeX template\]</span>(<a href="https://github.com/jgm/pandoc/blob/master/data/templates/default.latex" class="uri">https://github.com/jgm/pandoc/blob/master/data/templates/default.latex</a>) and is how <code>pandoc</code> usually tells LaTeX how to include references output).</p>
<p>For illustration purposes, let’s create a new file that we’ll call <strong>references.bib</strong> and save it with this content:</p>
<pre class="bibtex"><code>@InProceedings{lyngs2019,
  title = {Self-{{Control}} in {{Cyberspace}}: Applying {{Dual Systems Theory}} to a {{Review}} of {{Digital Self}}-{{Control Tools}}},
  booktitle = {{{CHIConference}} on {{Human Factors}} in {{Computing Systems Proceedings}} ({{CHI}} 2019)},
  author = {Ulrik Lyngs and Kai Lukoff and Petr Slovak and Reuben Binns and Adam Slack and Michael Inzlicht and Max {Van Kleek} and Nigel Shadbolt},
  date = {2019},
  publisher = {{ACM}},
  location = {{New York, NY, USA}},
  doi = {10.1145/3290605.3300361}
}</code></pre>
<p>Now let’s point to this as our bibliography in our R Markdown file, cite it, and add a ‘References’ heading by the end of the document:</p>
<pre class="markdown"><code>---
title: &quot;R Markdown + LaTeX Templates = &lt;3&quot;
silly-abstract: &quot;This is the greatest and best abstract in the world.&quot;
silly-author-summary: &quot;The important thing to know about this paper is that it is was written in close collaboration with Tenacious D, without whom our academic universe would have seized to be.&quot;
output: 
  bookdown::pdf_document2:
    template: plos_latex_template.tex
bibliography: references.bib
---

# Hello, LaTeX template!

This is a test.
This is a citation: @lyngs2019


```r
2 + 2
```

```
## [1] 4
```

# References</code></pre>
<p>And when we knit, we get the expected output:</p>
<p><img src="/post/2021-12-02-four_steps_latex_rmd/citations-csl.png" width="100%" style="display: block; margin: auto;" /></p>
<p>If we inspect the generated <strong>.tex</strong> file when we build to PDF (save this by adding <code>keep_tex: true</code> under the <code>bookdown::pdf_document2</code> options), we can see that the citation text itself in the body is included as plain text:</p>
<pre class="latex"><code>This is a citation: Lyngs et al. (2019)</code></pre>
<p>And in the references section the citation is included in a <code>CSLReferences</code> environment like this:</p>
<pre class="latex"><code>\begin{CSLReferences}{1}{0}
\leavevmode\vadjust pre{\hypertarget{ref-lyngs2019}{}}%
Lyngs, Ulrik, Kai Lukoff, Petr Slovak, Reuben Binns, Adam Slack, Michael Inzlicht, Max Van Kleek, and Nigel Shadbolt. 2019. {``Self-{Control} in {Cyberspace}: Applying {Dual Systems Theory} to a {Review} of {Digital Self}-{Control Tools}.&#39;&#39;} In \emph{{CHIConference} on {Human Factors} in {Computing Systems Proceedings} ({CHI} 2019)}. {New York, NY, USA}: {ACM}. \url{https://doi.org/10.1145/3290605.3300361}.

\end{CSLReferences}</code></pre>
</div>
<div id="natbib" class="section level2">
<h2>Natbib</h2>
<p>To use the <a href="https://www.overleaf.com/learn/latex/Bibliography_management_with_natbib"><code>natbib</code> package</a> for referencing, first add <code>citation_package: natbib</code> <strong>in the YAML header of your R Markdown file:</strong></p>
<pre class="markdown"><code>...
output: 
  bookdown::pdf_document2:
    template: plos_latex_template.tex
    citation_package: natbib
bibliography: references.bib</code></pre>
<p>Then, <strong>in the LaTeX template</strong> (1) add `\usepackage<span class="math display">\[options\]</span>{natbib}` to include the <code>natbib</code> package, and set a <a href="https://www.overleaf.com/learn/latex/Natbib_bibliography_styles">citation style</a> with `\bibliographystyle{stylename}`, somewhere before `\begin{document}`.
(2) point to your bibliography before <code>\end{document}</code>.</p>
<p>In our example, the PLOS template already comes with a style sheet in their <strong>plos2015.bst</strong> file, so we’ll use that.
The PLOS template also includes the <code>cite</code> package — we comment this out to use <code>natbib</code> instead.</p>
<pre class="latex"><code>% cite package, to clean up citations in the main text. Do not remove.
% \usepackage{cite}

...

\usepackage[numbers]{natbib}
\bibliographystyle{plos2015.bst}

...

\bibliography{$bibliography$}
\end{document}</code></pre>
<p>When we knit, we get this:</p>
<p><img src="/post/2021-12-02-four_steps_latex_rmd/citations-natbib.png" width="100%" style="display: block; margin: auto;" /></p>
<p>If we inspect the generated <strong>.tex</strong> file behind the PDF, we can see that our citation is generated with the <code>\citep</code> command, and the bibliography is simply generated from the <code>\bibliography</code> call.</p>
<pre class="latex"><code>This is a citation: \citep{lyngs2019}

...

\bibliography{references.bib}</code></pre>
</div>
<div id="biblatex" class="section level2">
<h2>Biblatex</h2>
<p>To use <a href="https://www.overleaf.com/learn/latex/Bibliography_management_with_biblatex"><code>biblatex</code></a> for citations, follow quite similar steps to the ones for <code>natbib</code>.
First, add <code>citation_package: biblatex</code> in the YAML header of your R Markdown file:</p>
<pre class="latex"><code>...
output: 
  bookdown::pdf_document2:
    template: plos_latex_template.tex
    citation_package: biblatex
bibliography: references.bib</code></pre>
<p>Then, <strong>in the LaTeX template</strong> (1) add `\usepackage{biblatex}` and point to your bibliography with `\addbibresource{references}` before `\begin{document}`.
(2) set where to print out your bibliography with the command `\printbibliography`.</p>
<pre class="latex"><code>\usepackage{biblatex}
\addbibresource{$bibliography$}

...

\printbibliography
\end{document}</code></pre>
<p>In the specific case of the PLOS template, it turns out we also need to change <code>\usepackage[utf8x]{inputenc}</code> to <code>\usepackage[utf8]{inputenc}</code>, see <a href="https://tex.stackexchange.com/questions/49610/use-biblatex-and-utf8">StackOverflow</a>.</p>
<p>When we knit, we get this:</p>
<p><img src="/post/2021-12-02-four_steps_latex_rmd/citations-biblatex.png" width="100%" style="display: block; margin: auto;" /></p>
<p>And if we inspect the generated <strong>.tex</strong> file behind the PDF, we can see that our citation is inserted in this way:</p>
<p>If we inspect the generated <strong>.tex</strong> file behind the PDF, we can see that our citation is generated with the <code>\autocite</code> command, and the bibliography is simply generated from the <code>\printbibliography</code> call.</p>
<pre class="latex"><code>This is a citation: \autocite{lyngs2019}

...

\printbibliography</code></pre>
<p>That’s it!
Go and change the LaTeX world with R Markdown!</p>
<iframe src="https://giphy.com/embed/4QhxFF23qseGY" width="480" height="387" frameBorder="0" class="giphy-embed" allowFullScreen>
</iframe>
<p>
<a href="https://giphy.com/gifs/4QhxFF23qseGY">via GIPHY</a>
</p>
</div>
</div>
